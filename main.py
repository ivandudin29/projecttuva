import os
import logging
import sys
from aiogram import Bot, Dispatcher, types
from aiogram.enums import ParseMode
from aiogram.filters import CommandStart, Command
from aiogram.types import Message
from aiogram.webhook.aiohttp_server import SimpleRequestHandler, setup_application
from aiohttp import web

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
TOKEN = os.getenv("BOT_TOKEN")
if not TOKEN:
    logger.error("‚ùå BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω! –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è")
    sys.exit(1)

# Render –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç PORT (–æ–±—ã—á–Ω–æ 10000)
PORT = int(os.getenv("PORT", 8080))
# –î–ª—è Render –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –¥–æ–º–µ–Ω
WEBHOOK_HOST = os.getenv("RENDER_EXTERNAL_HOSTNAME", f"localhost:{PORT}")
WEBHOOK_URL = f"https://{WEBHOOK_HOST}/webhook"

logger.info(f"üöÄ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:")
logger.info(f"‚Ä¢ PORT: {PORT}")
logger.info(f"‚Ä¢ WEBHOOK_URL: {WEBHOOK_URL}")
logger.info(f"‚Ä¢ TOKEN: {'–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' if TOKEN else '–ù–ï–¢!'}")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
bot = Bot(token=TOKEN, parse_mode=ParseMode.HTML)
dp = Dispatcher()

@dp.message(CommandStart())
async def cmd_start(message: Message):
    await message.answer(
        "üéâ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç!\n"
        f"–í–∞—à ID: {message.from_user.id}\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/ping - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏\n"
        "/id - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ\n"
        "/status - —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞"
    )
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞")

@dp.message(Command("ping"))
async def cmd_ping(message: Message):
    await message.answer("üèì Pong! –ë–æ—Ç –∂–∏–≤ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç")
    logger.info(f"Ping –æ—Ç {message.from_user.id}")

@dp.message(Command("id"))
async def cmd_id(message: Message):
    await message.answer(
        f"üë§ –í–∞—à ID: `{message.from_user.id}`\n"
        f"üí¨ ID —á–∞—Ç–∞: `{message.chat.id}`\n"
        f"üìù –¢–∏–ø —á–∞—Ç–∞: {message.chat.type}",
        parse_mode=ParseMode.MARKDOWN_V2
    )

@dp.message(Command("status"))
async def cmd_status(message: Message):
    await message.answer(
        f"‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ Render\n"
        f"üåê URL: {WEBHOOK_HOST}\n"
        f"üîß –ü–æ—Ä—Ç: {PORT}"
    )

@dp.message()
async def echo(message: Message):
    await message.answer(f"–í—ã —Å–∫–∞–∑–∞–ª–∏: {message.text}")

async def on_startup(bot: Bot):
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ–±—Ö—É–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ"""
    logger.info("üîÑ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ–±—Ö—É–∫–∞...")
    
    try:
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –≤–µ–±—Ö—É–∫
        await bot.delete_webhook(drop_pending_updates=True)
        logger.info("–°—Ç–∞—Ä—ã–π –≤–µ–±—Ö—É–∫ —É–¥–∞–ª–µ–Ω")
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π
        await bot.set_webhook(
            url=WEBHOOK_URL,
            drop_pending_updates=True,
            allowed_updates=dp.resolve_used_update_types()
        )
        logger.info(f"‚úÖ –í–µ–±—Ö—É–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {WEBHOOK_URL}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º
        webhook_info = await bot.get_webhook_info()
        logger.info(f"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ–±—Ö—É–∫–µ: {webhook_info.url}")
        logger.info(f"–û–∂–∏–¥–∞—é—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: {webhook_info.pending_update_count}")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –≤–µ–±—Ö—É–∫–∞: {e}")

async def on_shutdown(bot: Bot):
    """–û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏"""
    logger.info("üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...")
    await bot.delete_webhook(drop_pending_updates=True)
    await bot.session.close()
    logger.info("–°–µ—Å—Å–∏—è –∑–∞–∫—Ä—ã—Ç–∞")

async def health_check(request):
    """Health check –¥–ª—è Render"""
    return web.Response(
        text="OK",
        status=200,
        headers={"Content-Type": "text/plain"}
    )

async def webhook_info_page(request):
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤–µ–±—Ö—É–∫–µ"""
    try:
        info = await bot.get_webhook_info()
        html = f"""
        <html>
        <head><title>Telegram Bot Status</title></head>
        <body>
            <h1>ü§ñ Telegram Bot Status</h1>
            <p><strong>Webhook URL:</strong> {info.url or 'Not set'}</p>
            <p><strong>Pending Updates:</strong> {info.pending_update_count}</p>
            <p><strong>Last Error:</strong> {info.last_error_message or 'None'}</p>
            <p><strong>Service URL:</strong> https://{WEBHOOK_HOST}</p>
            <hr>
            <p>Health check: <a href="/health">/health</a></p>
            <p>Webhook endpoint: <a href="/webhook">/webhook</a></p>
        </body>
        </html>
        """
        return web.Response(text=html, content_type="text/html")
    except Exception as e:
        return web.Response(text=f"Error: {e}", status=500)

def main():
    """–ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–ø—É—Å–∫–∞/–æ—Å—Ç–∞–Ω–æ–≤–∫–∏
    dp.startup.register(on_startup)
    dp.shutdown.register(on_shutdown)
    
    # –°–æ–∑–¥–∞–µ–º –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    app = web.Application()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤–µ–±—Ö—É–∫
    webhook_handler = SimpleRequestHandler(
        dispatcher=dp,
        bot=bot,
    )
    webhook_handler.register(app, path="/webhook")
    
    # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
    app.router.add_get("/", webhook_info_page)
    app.router.add_get("/health", health_check)
    app.router.add_get("/status", webhook_info_page)
    
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    setup_application(app, dp, bot=bot)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
    logger.info(f"üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É {PORT}")
    web.run_app(
        app,
        host="0.0.0.0",  # –í–∞–∂–Ω–æ: —Å–ª—É—à–∞–µ–º –≤—Å–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
        port=PORT,
        access_log=logger
    )

if __name__ == "__main__":
    main()
